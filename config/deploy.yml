service: vrp-app
image: mayur311002/vrp_new_app_app-arm64
servers:
  - 157.180.87.7

registry:
  username: mayur311002
  password:
    - KAMAL_REGISTRY_PASSWORD
ssh:
  user: root
env:
  clear:
    POSTCODES_IO_URL: http://postcodes-app:8000
    OSRM_URL: http://osrm:5000
    STREAMLIT_SERVER_ADDRESS: 0.0.0.0
    STREAMLIT_BROWSER_SERVER_HEADLESS: true

accessories:
  osrm:
    image: mayur311002/vrp_new_app_osrm:latest-arm64
    host: 157.180.87.7
    port: "5000:5000"
    volumes:
      - /data/osrm:/data
    cmd: osrm-routed --algorithm mld /data/united-kingdom-latest.osrm
    options: 
      name: osrm
      restart: unless-stopped
      "log-opt": max-size=10m

  postcodes-db:
    image: postgres:15-alpine
    host: 157.180.87.7
    env:
      clear:
        POSTGRES_USER: postcodesio
        POSTGRES_DB: postcodesio
      secret:
        - POSTGRES_PASSWORD
    volumes:
      - /data/postgres:/var/lib/postgresql/data
    options:
      name: postcodes-db
      restart: unless-stopped

  postcodes-app:
    image: mayur311002/vrp_new_app_postcodes_app:latest-arm64
    host: 157.180.87.7
    port: "8000:8000"
    env:
      clear:
        DATABASE_URL: postgresql://postcodesio:${POSTGRES_PASSWORD}@postcodes-db:5432/postcodesio
      secret:
        - POSTGRES_PASSWORD
    options:
      name: postcodes-app
      restart: unless-stopped
    cmd: >
      bash -c 'wait-for-it postcodes-db:5432 --timeout=120 -- 
      ./entrypoint.sh'

builder:
  arch: arm64
